---
import BaseLayout from './BaseLayout.astro';
import Nav from '../components/Nav.astro';
import Footer from '../components/Footer.astro';
import Hero from '../components/Hero.astro';
import Breadcrumb from '../components/Breadcrumb.astro';
import ContactCTA from '../components/ContactCTA.astro';
import SchemaOrg from '../components/SchemaOrg.astro';

interface Props {
  frontmatter: {
    title: string;
    h1: string;
    description: string;
    keywords: string;
    canonical: string;
    heroImage: string;
    heroSubtitle: string;
    schema: Record<string, unknown>;
    breadcrumbLabel: string;
  };
  headings: { text: string; slug: string; depth: number }[];
}

const { frontmatter, headings } = Astro.props;

const tocHeadings = headings
  .filter(h => h.depth === 2 || h.depth === 3)
  .map(h => ({ text: h.text, id: h.slug, depth: h.depth }));
---

<BaseLayout
  title={frontmatter.title}
  description={frontmatter.description}
  keywords={frontmatter.keywords}
  canonical={frontmatter.canonical}
>
    <SchemaOrg schema={frontmatter.schema} slot="schema" />

    <Nav transparent={true} />

    <Hero
      title={frontmatter.h1}
      subtitle={frontmatter.heroSubtitle}
      ctaText="Kostenlose Erstberatung anfragen"
      ctaHref="#kontakt-cta"
      backgroundImage={frontmatter.heroImage}
    />

    <Breadcrumb items={[
      { label: 'Home', href: '/' },
      { label: frontmatter.breadcrumbLabel },
    ]} />

    <!-- Main content area -->
    <div class="max-w-7xl mx-auto px-6 py-16 lg:py-20">
        <div class="lg:grid lg:grid-cols-[260px_1fr] lg:gap-14">

            <!-- Sidebar TOC (Desktop) -->
            {tocHeadings.length > 0 && (
                <aside class="hidden lg:block">
                    <nav class="sticky top-28">
                        <p class="text-xs font-semibold text-gold tracking-wide-plus uppercase mb-4">Inhalt</p>
                        <ul class="space-y-1 border-l border-gray-200">
                            {tocHeadings.map((heading) => (
                                <li>
                                    <a
                                        href={`#${heading.id}`}
                                        class:list={[
                                            "block text-sm text-gray-500 hover:text-navy hover:border-l-gold border-l-2 border-transparent -ml-px px-4 py-1.5 transition-all",
                                            heading.depth === 3 && "pl-7 text-xs",
                                        ]}
                                    >
                                        {heading.text}
                                    </a>
                                </li>
                            ))}
                        </ul>
                        <div class="mt-8">
                            <a href="#kontakt-cta" class="block text-center bg-gold text-navy-dark px-4 py-2.5 rounded text-sm font-semibold hover:bg-gold-light transition">
                                Erstberatung anfragen
                            </a>
                        </div>
                    </nav>
                </aside>
            )}

            <!-- Mobile TOC -->
            {tocHeadings.length > 0 && (
                <div class="lg:hidden mb-10">
                    <details class="border border-gray-200 rounded group">
                        <summary class="cursor-pointer text-sm font-semibold text-navy flex items-center justify-between px-5 py-4">
                            Inhaltsverzeichnis
                            <svg class="w-4 h-4 text-gold transition-transform group-open:rotate-45" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                            </svg>
                        </summary>
                        <nav class="px-5 pb-4 space-y-1">
                            {tocHeadings.map((heading) => (
                                <a
                                    href={`#${heading.id}`}
                                    class:list={[
                                        "block text-sm text-gray-600 hover:text-navy transition py-1",
                                        heading.depth === 3 && "ml-4 text-xs text-gray-500",
                                    ]}
                                >
                                    {heading.text}
                                </a>
                            ))}
                        </nav>
                    </details>
                </div>
            )}

            <!-- Article content -->
            <article class="article-content min-w-0">
                <div class="prose prose-lg max-w-none
                    prose-headings:font-serif prose-headings:text-navy
                    prose-h2:text-2xl prose-h2:md:text-3xl prose-h2:font-bold prose-h2:mt-16 prose-h2:mb-6 prose-h2:pt-10 prose-h2:border-t prose-h2:border-gray-100
                    prose-h3:text-xl prose-h3:md:text-2xl prose-h3:font-semibold prose-h3:mt-10 prose-h3:mb-4
                    prose-p:text-gray-600 prose-p:leading-[1.85] prose-p:mb-5
                    prose-a:text-navy prose-a:underline prose-a:decoration-gold/40 prose-a:underline-offset-4 hover:prose-a:text-gold hover:prose-a:decoration-gold
                    prose-strong:text-navy prose-strong:font-semibold
                    prose-ul:my-6 prose-ul:space-y-2
                    prose-ol:my-6 prose-ol:space-y-2
                    prose-li:text-gray-600 prose-li:leading-relaxed
                    prose-table:my-8 prose-table:overflow-hidden prose-table:border prose-table:border-gray-200 prose-table:rounded
                    prose-thead:bg-navy-dark prose-th:text-white prose-th:text-left prose-th:px-4 prose-th:py-3 prose-th:text-sm prose-th:font-medium
                    prose-td:px-4 prose-td:py-3 prose-td:border-b prose-td:border-gray-100 prose-td:text-sm
                    prose-tr:even:bg-warm
                    prose-img:rounded
                    prose-hr:my-12 prose-hr:border-gray-100
                ">
                    <slot />
                </div>

                <!-- Mid-article CTA -->
                <div class="my-16 bg-navy-dark text-white rounded p-8 md:p-10">
                    <div class="md:flex md:items-center md:justify-between md:gap-8">
                        <div>
                            <h3 class="font-serif text-2xl font-bold mb-2">Haben Sie Fragen?</h3>
                            <p class="text-gray-400 text-sm max-w-md">Kontaktieren Sie uns f√ºr eine kostenlose und unverbindliche Erstberatung. Wir analysieren Ihre Situation und zeigen Ihnen Ihre Optionen auf.</p>
                        </div>
                        <a href="#kontakt-cta" class="mt-6 md:mt-0 inline-flex items-center gap-2 bg-gold text-navy-dark px-6 py-3 rounded text-sm font-semibold hover:bg-gold-light transition flex-shrink-0">
                            Jetzt beraten lassen
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 8l4 4m0 0l-4 4m4-4H3"></path></svg>
                        </a>
                    </div>
                </div>
            </article>
        </div>
    </div>

    <ContactCTA />
    <Footer />
</BaseLayout>
